(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const ee="modulepreload",te=function(e){return"/excelwizpro-frontend/"+e},F={},ne=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),a=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));o=Promise.allSettled(n.map(i=>{if(i=te(i),i in F)return;F[i]=!0;const l=i.endsWith(".css"),m=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${m}`))return;const w=document.createElement("link");if(w.rel=l?"stylesheet":ee,l||(w.as="script"),w.crossOrigin="",w.href=i,a&&w.setAttribute("nonce",a),document.head.appendChild(w),l)return new Promise((v,L)=>{w.addEventListener("load",v),w.addEventListener("error",()=>L(new Error(`Unable to preload CSS for ${i}`)))})}))}function c(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return o.then(s=>{for(const a of s||[])a.status==="rejected"&&c(a.reason);return t().catch(c)})},oe="13.0.0",re="https://excelwizpro-finalapi.onrender.com",ae=90*1e3,se=5e4,ce=2e4,ie=3;function q(e){return new Promise(t=>setTimeout(t,e))}function C(e){const t=document.getElementById(e);if(!t)throw new Error(`Missing element: #${e}`);return t}function le(e){let t=e+1,n="";for(;t>0;){const r=(t-1)%26;n=String.fromCharCode(65+r)+n,t=Math.floor((t-1)/26)}return n}function I(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}function ue(){try{return Object.fromEntries(new URLSearchParams(window.location.search))}catch{return{}}}const O=new Map;function N(e,t){return O.has(e)||O.set(e,new Set),O.get(e).add(t),()=>de(e,t)}function de(e,t){const n=O.get(e);n&&n.delete(t)}function y(e,t){const n=O.get(e);if(n)for(const r of n)try{r(t)}catch(o){console.warn(`EventBus handler for '${e}' failed:`,o)}}function fe(){var e,t,n,r,o,c,s;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((o=(r=Office.context)==null?void 0:r.diagnostics)==null?void 0:o.version)||"unknown",build:((s=(c=Office.context)==null?void 0:c.diagnostics)==null?void 0:s.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function me(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function we(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),y("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function pe(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await q(350+t*120)}return y("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function H(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),y("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function he(e){return H(async t=>{const n=t.workbook.worksheets;n.load("items/name"),await t.sync(),e.innerHTML="",n.items.forEach(r=>{const o=document.createElement("option");o.value=r.name,o.textContent=r.name,e.appendChild(o)})})}async function ge(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const r=n.onChanged;r&&r.add&&r.add(async()=>{y("workbook:changed")})}catch(r){console.warn("Sheet change listener unsupported:",r)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function ye(){return fe().version||"unknown"}function Ee(e){if(typeof AbortController>"u")return;const t=new AbortController,n=setTimeout(()=>t.abort(),e);return t.signal.addEventListener("abort",()=>clearTimeout(n)),t.signal}async function be(e,{timeout:t=ce,...n}={}){if(!navigator.onLine){const o=new Error("offline");throw o.code="OFFLINE",o}const r=n.signal||Ee(t);return fetch(e,{...n,signal:r})}async function V(e,t={}){let n=null;for(let r=1;r<=ie;r++){try{const o=await be(e,t);if(!o.ok){n=new Error(`HTTP ${o.status}`),n.status=o.status;continue}return o}catch(o){n=o,o.name==="AbortError"||o.code}await q(300*r)}throw n||new Error("fetchWithRetry failed")}let k=re;function G(){var e;try{const t=ue();if(t.apiBase)return k=t.apiBase,k;if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return k=n,k}}catch(t){console.warn("API base resolution error:",t)}return k}async function xe(e=5){const t=document.querySelector("main.container"),n=document.createElement("div");Object.assign(n.style,{padding:"6px",marginBottom:"8px",borderRadius:"6px",fontSize:"0.9rem",textAlign:"center"}),t&&t.prepend(n);const r=G();for(let o=1;o<=e;o++){try{if((await V(`${r}/health`,{timeout:4e3})).ok){n.textContent="‚úÖ Backend ready",n.style.background="#e6ffed",n.style.color="#0c7a0c",setTimeout(()=>n.remove(),2e3),y("backend:ready");return}}catch{}n.textContent=`‚è≥ Waking backend‚Ä¶ (${o}/${e})`,n.style.background="#fff4ce",n.style.color="#976f00"}n.textContent="‚ùå Backend unreachable",n.style.background="#fde7e9",n.style.color="#c22",y("backend:error")}async function Ce(e){const t=G();return(await(await V(`${t}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"})).json()).formula||'=ERROR("No formula returned")'}let S="",A=0,M=!1;async function ke(){return H(async e=>{const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const r=[],o=Object.create(null);for(const a of n.items){const i=a.visibility,l=i!=="Visible"?` (${i.toLowerCase()})`:"";r.push(`Sheet: ${a.name}${l}`);const m=a.getUsedRangeOrNullObject();if(m.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),m.isNullObject||m.rowCount<2)continue;const w=Math.min(3,m.rowCount),v=a.getRangeByIndexes(m.rowIndex,m.columnIndex,w,m.columnCount);v.load("values");const L=a.tables;L.load("items/name");const U=a.pivotTables;U.load("items/name"),await e.sync();const K=v.values,X=m.rowIndex+w,Q=m.rowIndex+m.rowCount-1,$=X+1,J=$+se-1,Z=Q+1,z=Math.min(Z,J);if(z>=$)for(let u=0;u<m.columnCount;u++){const g=[];for(let f=0;f<w;f++){const T=K[f][u];g[f]=T!==null&&T!==""&&T!==void 0?String(T).trim():""}let x="";for(let f=w-1;f>=0;f--)if(g[f]){x=g[f];break}if(!x)continue;let E=x;for(let f=0;f<w-1;f++)if(g[f]&&g[f]!==x){E=`${g[f]} - ${E}`;break}let d=I(E);o[d]?(o[d]+=1,d=`${d}__${o[d]}`):o[d]=1;const R=le(m.columnIndex+u),Y=a.name.replace(/'/g,"''");r.push(`${d} = '${Y}'!${R}${$}:${R}${z}`)}const j=L.items.map(u=>({table:u,header:u.getHeaderRowRange(),body:u.getDataBodyRange()}));j.forEach(u=>{u.header.load("values"),u.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:u,header:g}of j)r.push(`Table: ${u.name}`),(g.values&&g.values[0]||[]).forEach(E=>{if(!E)return;let d=I(`${u.name}.${E}`);o[d]?(o[d]+=1,d=`${d}__${o[d]}`):o[d]=1;const R=`${u.name}[${E}]`;r.push(`${d} = ${R}`)});U.items.forEach(u=>r.push(`PivotSource: ${u.name}`))}const c=t.names;c.load("items/name"),await e.sync();const s=[];for(const a of c.items){const i=a.getRange();i.load("address"),s.push({name:a.name,range:i})}return await e.sync(),s.forEach(({name:a,range:i})=>{r.push(`NamedRange: ${a}`);let l=I(a);o[l]?(o[l]+=1,l=`${l}__${o[l]}`):o[l]=1,r.push(`${l} = ${i.address}`)}),r.join(`
`)})}async function P(e=!1){if(!M)try{const t=Date.now();if(!e&&S&&t-A<ae){console.log("üîÑ Using cached Smart Column Map (recent)");return}M=!0,console.log("üîÑ Refreshing Smart Column Map‚Ä¶"),S=await ke(),A=Date.now(),console.log("‚úÖ Updated Smart Column Map"),y("columnMap:updated",{columnMap:S})}catch(t){console.warn("Auto-refresh failed:",t),y("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{M=!1}}function W(){return S}N("workbook:changed",()=>{S="",A=0,console.log("üßπ Column map cache invalidated due to workbook change")});let b=null;function Oe(){return b||(b=document.createElement("div"),b.className="exwz-toast-container",Object.assign(b.style,{position:"fixed",bottom:"12px",right:"12px",zIndex:9999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px"}),document.body.appendChild(b),b)}function p(e,t="info"){const n=Oe(),r=document.createElement("div");r.className="exwz-toast",r.textContent=e;const o={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",color:"#111",boxShadow:"0 2px 10px rgba(0,0,0,0.15)",background:"#f3f3f3"},c={info:{background:"#e5f1ff",color:"#084f94"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"},success:{background:"#e6ffed",color:"#0c7a0c"}};Object.assign(r.style,o,c[t]||c.info),n.appendChild(r),setTimeout(()=>r.remove(),2600)}const Se=Object.freeze(Object.defineProperty({__proto__:null,showToast:p},Symbol.toStringTag,{value:"Module"}));let h=null;function ve(){return h||(h=document.createElement("div"),h.className="exwz-error-panel",Object.assign(h.style,{borderRadius:"8px",padding:"8px 10px",marginTop:"8px",background:"#fde7e9",color:"#c22",fontSize:"0.85rem",display:"none"}),(document.querySelector("main.container")||document.body).appendChild(h),h)}function Le(e,t){const n=ve();if(n.style.display="block",n.innerHTML=`<strong>Error:</strong> ${e}`,t){const r=document.createElement("pre");r.style.marginTop="4px",r.style.whiteSpace="pre-wrap",r.textContent=t,n.appendChild(r)}}function D(){h&&(h.style.display="none",h.innerHTML="")}let _="",B=!1;async function Re(){const e=C("sheetSelect"),t=C("query"),n=C("output"),r=C("generateBtn"),o=C("clearBtn"),c=document.getElementById("insertBtn");await he(e),await P(!0),xe(),N("ui:toast",({message:s,kind:a})=>p(s,a)),N("columnMap:updated",()=>{}),r.addEventListener("click",async()=>{if(B)return;const s=t.value.trim();if(!s)return p("‚ö†Ô∏è Enter a request","warn");if(!navigator.onLine)return p("üì¥ Offline","warn");B=!0,r.disabled=!0,D(),n.textContent="‚è≥ Generating‚Ä¶";try{await P(!1),W()||await P(!0);const a=ye(),i={query:s,columnMap:W(),excelVersion:a,mainSheet:e.value},l=await Ce(i);_=l,n.textContent=l,p("‚úÖ Formula ready","success")}catch(a){console.error("Generation failed:",a),n.textContent="‚ùå Error ‚Äî see details",Le("Formula generation failed.",(a==null?void 0:a.message)||String(a))}finally{B=!1,r.disabled=!1}}),o.addEventListener("click",()=>{n.textContent="",t.value="",D()}),c?c.addEventListener("click",async()=>{if(!_)return p("‚ö†Ô∏è No formula to insert","warn");try{await Excel.run(async s=>{const a=s.workbook.getSelectedRange();if(a.load("rowCount,columnCount"),await s.sync(),a.rowCount!==1||a.columnCount!==1){const i=new Error("MULTI_CELL_SELECTION");throw i.code="MULTI_CELL_SELECTION",i}a.formulas=[[_]],await s.sync()}),p("‚úÖ Inserted","success")}catch(s){console.warn("Insert failed:",s),s&&s.code==="MULTI_CELL_SELECTION"?p("‚ö†Ô∏è Select a single cell first","warn"):p("‚ö†Ô∏è Select a cell first","warn")}}):console.warn("No #insertBtn found ‚Äî insert will not be available."),window.addEventListener("online",()=>{_&&p("üåê Back online ‚Äî formula restored","info")}),console.log("üü¢ ExcelWizPro UI ready")}console.log(`üß† ExcelWizPro Taskpane v${oe} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});(async function(){console.log("üß† Boot sequence‚Ä¶");const t=await me();if(!await we(t)||!await pe())return;await ge(),await Re();const{showToast:n}=await ne(async()=>{const{showToast:r}=await Promise.resolve().then(()=>Se);return{showToast:r}},void 0);n("‚úÖ ExcelWizPro ready!","success")})();
